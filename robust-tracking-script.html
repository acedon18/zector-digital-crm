<!-- Zector Digital Lead Tracking Script - ROBUST VERSION -->
<script type="text/javascript">
(function() {
  var zld = {
    customerId: 'ZECTOR_123',
    domain: 'zectordigital.es',
    scriptId: 'zld_ZECTOR_123_' + Date.now(),
    config: {
      gdprCompliant: true,
      anonymizeIp: true,
      trackScrollDepth: true,
      trackDownloads: true,
      trackFormSubmissions: true,
      retryAttempts: 3,
      retryDelay: 1000
    }
  };

  // Enhanced tracking function with retry logic and fallback
  zld.track = function(event, data) {
    var payload = {
      event: event,
      data: data || {},
      timestamp: new Date().toISOString(),
      url: window.location.href,
      referrer: document.referrer,
      userAgent: navigator.userAgent,
      customerId: zld.customerId,
      domain: zld.domain
    };

    if (zld.config.anonymizeIp) {
      payload.anonymizeIp = true;
    }

    // Retry function
    function attemptTrack(attempt) {
      attempt = attempt || 1;
      
      console.log('Zector tracking attempt ' + attempt + ' for event:', event);
      
      // Primary tracking endpoint
      fetch('https://zector-digital-crm-leads.vercel.app/api/track', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json'
        },
        mode: 'cors',
        credentials: 'omit',
        body: JSON.stringify(payload)
      }).then(function(response) {
        if (!response.ok) {
          throw new Error('HTTP ' + response.status + ': ' + response.statusText);
        }
        return response.json();
      }).then(function(data) {
        console.log('‚úÖ Zector tracking successful for event:', event, data);
      }).catch(function(error) {
        console.warn('‚ùå Zector tracking attempt ' + attempt + ' failed:', error.message);
        
        // Retry logic
        if (attempt < zld.config.retryAttempts) {
          setTimeout(function() {
            attemptTrack(attempt + 1);
          }, zld.config.retryDelay * attempt);
        } else {
          // Final fallback - try with image beacon
          console.log('üîÑ Trying fallback image beacon method for event:', event);
          zld.trackWithBeacon(event, payload);
        }
      });
    }

    // Start tracking attempt
    attemptTrack();
  };

  // Fallback beacon tracking method
  zld.trackWithBeacon = function(event, payload) {
    try {
      // Use navigator.sendBeacon if available
      if (navigator.sendBeacon) {
        var success = navigator.sendBeacon(
          'https://zector-digital-crm-leads.vercel.app/api/track',
          JSON.stringify(payload)
        );
        if (success) {
          console.log('‚úÖ Zector beacon tracking successful for event:', event);
          return;
        }
      }
      
      // Fallback to image pixel tracking
      var img = new Image();
      var params = new URLSearchParams();
      params.append('data', JSON.stringify(payload));
      
      img.onload = function() {
        console.log('‚úÖ Zector image tracking successful for event:', event);
      };
      
      img.onerror = function() {
        console.warn('‚ùå All tracking methods failed for event:', event);
      };
      
      img.src = 'https://zector-digital-crm-leads.vercel.app/api/track?' + params.toString();
      
    } catch (e) {
      console.warn('‚ùå Fallback tracking failed:', e.message);
    }
  };

  // Enhanced connection test
  zld.testConnection = function() {
    console.log('üß™ Testing connection to tracking endpoint...');
    
    fetch('https://zector-digital-crm-leads.vercel.app/api/health', {
      method: 'GET',
      mode: 'cors',
      credentials: 'omit'
    }).then(function(response) {
      if (response.ok) {
        console.log('‚úÖ Connection test successful - API is reachable');
        return response.json();
      } else {
        throw new Error('HTTP ' + response.status);
      }
    }).then(function(data) {
      console.log('üìä API health check:', data);
    }).catch(function(error) {
      console.warn('‚ùå Connection test failed:', error.message);
    });
  };

  // Test connection first
  zld.testConnection();

  // Initial page view tracking with delay to ensure DOM is ready
  setTimeout(function() {
    zld.track('page_view', {
      title: document.title,
      path: window.location.pathname
    });
  }, 100);

  // Scroll depth tracking
  if (zld.config.trackScrollDepth) {
    var maxScroll = 0;
    var scrollTimeout;
    
    window.addEventListener('scroll', function() {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(function() {
        var scrollPercent = Math.round((window.scrollY / (document.body.scrollHeight - window.innerHeight)) * 100);
        if (scrollPercent > maxScroll && scrollPercent % 25 === 0) {
          maxScroll = scrollPercent;
          zld.track('scroll_depth', { depth: scrollPercent });
        }
      }, 100);
    });
  }

  // Download tracking
  if (zld.config.trackDownloads) {
    document.addEventListener('click', function(e) {
      var link = e.target.closest('a');
      if (link && link.href) {
        var url = link.href;
        var isDownload = /\.(pdf|doc|docx|xls|xlsx|ppt|pptx|zip|rar|mp3|mp4|avi)$/i.test(url);
        if (isDownload) {
          zld.track('download', {
            url: url,
            fileName: url.split('/').pop()
          });
        }
      }
    });
  }

  // Form submission tracking
  if (zld.config.trackFormSubmissions) {
    document.addEventListener('submit', function(e) {
      var form = e.target;
      if (form.tagName === 'FORM') {
        zld.track('form_submission', {
          formId: form.id || 'unknown',
          formAction: form.action || window.location.href
        });
      }
    });
  }

  // Session tracking
  var sessionStart = Date.now();
  window.addEventListener('beforeunload', function() {
    var sessionDuration = Date.now() - sessionStart;
    // Use beacon for unload events as they're more reliable
    if (navigator.sendBeacon) {
      navigator.sendBeacon(
        'https://zector-digital-crm-leads.vercel.app/api/track',
        JSON.stringify({
          event: 'session_end',
          data: { duration: sessionDuration },
          timestamp: new Date().toISOString(),
          url: window.location.href,
          customerId: zld.customerId,
          domain: zld.domain
        })
      );
    }
  });

  // Make zld globally available
  window.ZectorLeadDigital = zld;

  console.log('üöÄ Zector Digital Lead Tracking initialized for zectordigital.es');
})();
</script>

<!-- GDPR Compliance Notice -->
<script type="text/javascript">
// Show GDPR notice if needed
if (!localStorage.getItem('zld_consent_ZECTOR_123')) {
  // Add your GDPR consent banner here
  console.log('üìã GDPR consent required for lead tracking');
}
</script>
